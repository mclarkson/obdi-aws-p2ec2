<!--
 Obdi - a REST interface and GUI for deploying software
 Copyright (C) 2014  Mark Clarkson

 This program is free software: you can redistribute it and/or modify
 it under the terms of the GNU General Public License as published by
 the Free Software Foundation, either version 3 of the License, or
 (at your option) any later version.

 This program is distributed in the hope that it will be useful,
 but WITHOUT ANY WARRANTY; without even the implied warranty of
 MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 GNU General Public License for more details.

 You should have received a copy of the GNU General Public License
 along with this program.  If not, see <http://www.gnu.org/licenses/>.
-->

<!-- tool_content -->

<!-- A modal dialog box -->

<script type="text/ng-template" id="helloModal.html">
    <div class="modal-header">
        <h3 class="modal-title">Hello World! Runscript</h3>
    </div>
    <div class="modal-body">
      Hello {{name}}
    </div>
    <div class="modal-footer">
        <button class="btn btn-primary" ng-click="cancel()">Ok</button>
    </div>
</script>

<style>.modal-body table tr td {padding: 4px;}</style>

<div ng-controller="awsp2ec2">

  <div class="row">
    <div class="col-lg-12">
      <h3 class="page-header" style="margin-bottom: -20px">
        Amazon EC2
      <button class="btn btn-sm btn-success pull-right" type="button"
        ng-if="create_volume"
        ng-click="Migrate()" style="margin-top: -5px; margin-right: 8px;">
        <i class="fa fa-check"> </i> Create {{CreateWhat()}}</button>
      <button class="btn btn-sm btn-success pull-right" type="button"
        ng-click="Restart()" ng-if="!create_volume"
        style="margin-top: -5px;">
        <i class="fa fa-refresh"> </i> Restart</button>
      <button class="btn btn-sm btn-default pull-right" type="button"
        ng-click="goBack()" style="margin-top: -5px; margin-right: 8px;">
        <i class="fa fa-arrow-left"> </i> Go Back</button></h3>
    </div>
  </div>

  <style>
    .alert {
      margin-top: 20px;
      margin-bottom: 0;
    }
  </style>

  <div class="row">
    <div class="col-sm-12">

      <!--
      <div class="alert alert-danger alert-dismissable" ng-show="message">
        <button type="button" class="close" data-dismiss="alert"
          aria-hidden="true">&times;</button>
        {{message}}
      </div>
      <div class="alert alert-success alert-dismissable" ng-show="okmessage">
        <button type="button" class="close" data-dismiss="alert"
          aria-hidden="true">&times;</button>
        {{okmessage}}
      </div>
      -->

      <div class="alert alert-danger alert-dismissable" ng-show="message">
        <button type="button" class="close" data-dismiss="alert"
          aria-hidden="true">&times;</button>
        {{message}}
      </div>
      <div class="alert alert-success alert-dismissable" ng-show="okmessage">
        <button type="button" class="close" data-dismiss="alert"
          aria-hidden="true">&times;</button>
        {{okmessage}}
        <span ng-if="message_jobid">
        See: <a href="#" ng-click="showOutputlines(message_jobid)">
        jobid:{{message_jobid}}</a>
        </span>
      </div>

    </div>
  </div>

  <style>
    .box {
      transition: all 0.2s linear;
      max-height: 200px;
    }

    .overflowhidden {
      overflow: hidden;
    }

    .hidden {
      display: none;
    }

    .visuallyhidden {
      max-height: 0;
    }
  </style>

  <div id="mainbtnblock" class="box" style="margin-top: 20px">

    Amazon AWS EC2 instances or Amazon Machine Images (AMIs) can be created using this page.

    <div ng-if="mainview">

      <div class="row" ng-if="!showkeybtnblockhidden">
	<div class="col-sm-12" style="margin-top: 20px">

	  <div class="vbtn" style="margin-bottom: 8px;">
	    <div style="margin-left: 8px" class="btn-group"
	    uib-dropdown is-open="status.isopen">
	      <button type="button" class="btn btn-primary" uib-dropdown-toggle
	      ng-disabled="btnregionListDisabled">
		Choose AWS Region <span class="caret"></span>
	      </button>
	      <ul uib-dropdown-menu role="menu">
		<li ng-repeat="choice in regions">
		<a href ng-click="envChoice(choice, $event)">
		  {{choice.Name}}</a>
		</li>
	      </ul>
	    </div>
	  </div>

	  <div class="vbtn" style="margin-bottom: 8px">
	    <div class="btn-group">
	      <button type="button" class="btn btn-primary" style="margin-left: 8px;"
	      ng-click="ListInstances()" ng-disabled="btnlistInstancesDisabled">
		List Instances
	      </button>
	    </div>
	  </div>

	  <div class="vbtn">
	    <div class="btn-group">
	      <button type="button" class="btn btn-primary" style="margin-left: 8px;"
	      ng-click="CreateVolume()" ng-disabled="btncreateVolumeDisabled">
		Create Instance
	      </button>
	    </div>
	  </div>

          <!--
	  <div class="vbtn">
	    <div class="btn-group">
	      <button type="button" class="btn btn-primary" uib-dropdown-toggle
	      style="margin-left: 8px;"
	      ng-click="RunHelloScript()" ng-disabled="btncreateInstanceDisabled">
		Create Instance
	      </button>
	    </div>
	  </div>
          -->

	</div>
      </div>
    </div>
  </div>

  <div class="row" ng-if="envchosen" style="margin-top: 0">
    <div class="col-sm-12">
      <h4 class="page-header">AWS Region: {{region.Name}}</h4>
      <p>Press the List Instances button to see the
        available instances to check you're in the right region.</p>
      <p>Press the Create Volume button to start
        setting up the new instance.</p>
    </div>
  </div>

  <div class="row" ng-if="list_instances" style="margin-top: 0">
    <div class="col-sm-12">
      <h4 class="page-header">AWS Region: {{region.Name}} - Instances</h4>

      <div ng-if="list_instances_inprogress">
        <p>Getting the list of instances
        <i class="ellipsis"><i>.</i><i>.</i><i>.</i></i></p>
      </div>

      <div ng-if="list_instances_empty">
        <p>There are no instances.</p>
      </div>

      <div ng-if="list_instances_results">
	<div class="table-responsive" style="margin-top: 8px;">
	  <table class="table table-striped table-bordered"
	    style="margin-bottom:20px;">
	    <thead>
	    <tr>
	      <th>#</th>
	      <th>Id</th>
	      <th>Tag</th>
	      <th>Key</th>
	      <th>Type</th>
	      <th>Private IP</th>
	    </tr>
	    </thead>
	    <tbody>
	      <tr ng-repeat="item in instances | filter:instancesfilter"
               class="{{style(item.State.Code)}}">
		<td>{{$index+1}}</td>
		<td>{{item.InstanceId}}</td>
		<td>{{item.Tags[0].Value}}</td>
		<td>{{item.KeyName}}</td>
		<td>{{item.InstanceType}}</td>
		<td>{{item.PrivateIPAddress}}</td>
	      </tr>
	    </tbody>
	  </table>
	</div> <!-- table-responsive -->
      </div>

    </div>
  </div>

  <div class="row" ng-if="create_volume">
    <div class="col-sm-12" id="crvol">
      <h4 class="page-header">AWS Region: {{region.Name}} - Create Instance</h4>

      <!--<p>Set EBS volume size:</p>-->
      <div class="form-horizontal prepend-xs-1" role="form">

      <!-- TODO TODO
           Calculate Directory Size box should only be shown when
           RSYNC_BACKUP_1 capability is set and we're being called from it.
           Also, this is a mess of styles - TODO!
      -->

	<div class="form-group" style="margin-top:24px;margin-bottom:12px;">
	  <label for="rsync_opts" class="col-sm-3 control-label">
            <span class="mypopover"
              popover-trigger="mouseenter mouseleave"
              popover-title="Size Query"
              popover-placement="right"
              popover-append-to-body="true"
              uib-popover="Press the Calculate Directory Size button to calculate
                           the size of the directory that will be written to
                           Amazon EC2. Select 'Notify me when done' to get a
                           system notification when the calculation is complete.
                           The Root Disk Size field, below, will be updated
                           with the calculated size plus 20 GB.">
              Size Query
            </span>
          </label>
	  <div class="col-sm-9">
	    <div class="btn-group">
	      <button class="btn btn-primary" ng-click="CalcDirSize()">
		Calculate Directory Size&nbsp;
		<i class="fa fa-chevron-circle-right"> </i>
	      </button>
	      <button disabled="disabled" class="btn btn-primary" ng-disabled="true">
		<span ng-if="dirsize_not_started"
                  style="background-color:white; padding-left:8px; padding-right:8px;
		  padding-top:2px; padding-bottom:2px; border-radius:4px; color:black">
		  Not calculated</span>
		<span ng-if="dirsize_in_progress"
                  style="background-color:white; padding-left:8px; padding-right:8px;
		  padding-top:2px; padding-bottom:2px; border-radius:4px; color:black">
		  Calculating <i class="ellipsis"><i>.</i><i>.</i><i>.</i></i>
		  </span>
		<span ng-if="dirsize_complete"
                  style="background-color:white; padding-left:8px; padding-right:8px;
		  padding-top:2px; padding-bottom:2px; border-radius:4px; color:black">
		  {{dirsize[0].sizeh}}</span>
	      </button>
	    </div>
	    <div class="checkbox">
	      <label>
		<input type="checkbox" ng-model="notifyme.now">
		Notify me when done
	      </label>
	    </div>
	  </div>
	</div>

	<div class="form-group">
	  <label for="size_gb" class="col-sm-3 control-label">
            <span class="mypopover"
              popover-trigger="mouseenter mouseleave"
              popover-title="Instance Type"
              popover-placement="right"
              popover-append-to-body="true"
              uib-popover="The instance type will be used if the Create Instance
                           option is selected. This can be changed by clicking
                           the Customise Instance button below.">
              Instance Type
            </span>
          </label>
          <div class="col-sm-5">
	    <input class="form-control col-xs-5" id="size_gb"
	      ng-model="datacopy.instance_type" placeholder="" type="text"
	      ng-trim='false' ng-disabled="true" required>
          </div>
	</div>

	<div class="form-group">
	  <label for="size_gb" class="col-sm-3 control-label">
            <span class="mypopover"
              popover-trigger="mouseenter mouseleave"
              popover-title="Root Disk Size"
              popover-placement="right"
              popover-append-to-body="true"
              uib-popover="The size of the Root Disk, /dev/sda or /dev/xvda, is
                           specified here. Enter an integer. Click the Customise
                           Root Disk button to set other EBS volume options for
                           this disk.">
                Root Disk Size
            </span>
          </label>

          <div class="col-sm-3">
	    <input class="form-control col-xs-3" id="size_gb"
	      ng-model="datacopy.size_gb" placeholder="E.g. 10"
              type="text" ng-trim='false' required>
          </div>
          <!--
          <div class="col-sm-3" style="padding-left:0;">
            <p style="padding-top: 7px;">GB</p>
          </div>
          -->
	</div>

        <div class="form-group">
          <div class="col-sm-offset-3 col-sm-3">
            <button style="" class="btn btn-default" type="button">
              <i class="fa fa-cog"></i> Customise Root Disk
            </button>
          </div>
        </div>

        <div class="form-group">
          <div class="col-sm-offset-3 col-sm-3">
            <button style="" class="btn btn-default" type="button">
              <i class="fa fa-cog"></i> Customise Instance
            </button>
          </div>
        </div>

	<div class="col-sm-offset-3 col-sm-7">
	  <div class="checkbox" style="padding-top: 0px;">
	    <label>
	      <input type="checkbox" ng-model="datacopy.wants_snapshot"
              ng-disabled="datacopy.wants_ami">
	      Create snapshot
	    </label>
	  </div>

	  <div class="checkbox" style="padding-top: 0px;">
	    <label>
	      <input type="checkbox" ng-model="datacopy.wants_ami"
              ng-disabled="!datacopy.wants_snapshot || (datacopy.wants_snapshot && datacopy.wants_instance)">
	      Create AMI
	    </label>
	  </div>

	  <div class="checkbox" style="padding-top: 0px;">
	    <label>
	      <input type="checkbox" ng-model="datacopy.wants_instance"
              ng-disabled="!datacopy.wants_ami">
	      Create Instance
	    </label>
	  </div>

        </div>
      </div>
    </div>
  </div>

  <style>
    @media(min-width:768px) {
      .right {
          text-align: right;
          clear: both;
      }
    }
  </style>

  <div class="row" ng-if="migrate.page" style="margin-top: 0">
    <div class="col-sm-12">
      <h4 class="page-header">
        AWS Region: {{region.Name}} - Creating {{CreateWhat()}}</h4>

      <!-- Availability Zone -->

      <div ng-if="migrate.obdi_worker_availzone.status == 'started'">
        <p class="col-sm-4 right"><b>Availability Zone:</b>
        <p class="col-sm-8">Getting the obdi worker instance name
          <i class="ellipsis"><i>.</i><i>.</i><i>.</i></i></p>
      </div>
      <div ng-if="migrate.obdi_worker_availzone.status == 'gotinstanceid'">
        <p class="col-sm-4 right"><b>Availability Zone:</b>
        <p class="col-sm-8">Getting availability zone for
          {{awsdata.Aws_obdi_worker_instance_id}}
          <i class="ellipsis"><i>.</i><i>.</i><i>.</i></i></p>
      </div>
      <div ng-if="migrate.obdi_worker_availzone.status == 'finished'">
        <p class="col-sm-4 right"><b>Availability Zone:</b>
        <p class="col-sm-8">Obdi worker {{awsdata.Aws_obdi_worker_instance_id}}
          is in zone {{awsworker[0].Instances[0].AvailabilityZone}}
        </p>
      </div>

      <!-- Check Availability Zone -->

      <div ng-if="migrate.obdi_worker_check_availzone.status == 'started'">
        <p class="col-sm-offset-4 col-sm-8">Checking status
          <i class="ellipsis"><i>.</i><i>.</i><i>.</i></i>
        </p>
      </div>
      <div ng-if="migrate.obdi_worker_check_availzone.status == 'finished'">
        <p class="col-sm-offset-4 col-sm-8">Zone Status
          {{migrate.obdi_worker_check_availzone.state}}<br>
          {{migrate.obdi_worker_check_availzone.message}}
        </p>
      </div>

      <!-- Create Volume -->

      <div ng-if="migrate.create_volume.status == 'started'">
        <p class="col-sm-4 right"><b>EBS Volume:</b>
        <p class="col-sm-8">Creating volume
          <i class="ellipsis"><i>.</i><i>.</i><i>.</i></i>
        </p>
      </div>
      <div ng-if="migrate.create_volume.status == 'finished'">
        <p class="col-sm-4 right"><b>EBS Volume:</b>
        <p class="col-sm-8">Volume created as
          {{migrate.create_volume.volumeid}}<br>
        </p>
      </div>

      <!-- Attach Volume -->

      <div ng-if="migrate.attach_volume.status == 'waiting'">
        <p class="col-sm-offset-4 col-sm-8">Waiting for
          volume to become ready
          <i class="ellipsis"><i>.</i><i>.</i><i>.</i></i>
        </p>
      </div>
      <div ng-if="migrate.attach_volume.status == 'started'">
        <p class="col-sm-offset-4 col-sm-8">Attaching volume
          <i class="ellipsis"><i>.</i><i>.</i><i>.</i></i>
        </p>
      </div>
      <div ng-if="migrate.attach_volume.status == 'retrying'">
        <p class="col-sm-offset-4 col-sm-8">Attaching volume
          failed. Trying another mount point
          <i class="ellipsis"><i>.</i><i>.</i><i>.</i></i>
        </p>
      </div>
      <div ng-if="migrate.attach_volume.status == 'attaching'">
        <p class="col-sm-offset-4 col-sm-8">Waiting for attachment
          {{migrate.attach_volume.mountpoint}}
          to become ready
          <i class="ellipsis"><i>.</i><i>.</i><i>.</i></i>
        </p>
      </div>
      <div ng-if="migrate.attach_volume.status == 'finished'">
        <p class="col-sm-offset-4 col-sm-8">Volume attached to
          {{awsdata.Aws_obdi_worker_instance_id}} at
          {{migrate.attach_volume.mountpoint}}
        </p>
      </div>

      <!-- Mount Volume and Copy Files -->

      <div ng-if="migrate.copy_files.status == 'started'">
        <p class="col-sm-4 right"><b>Copy Files:</b></p>
        <p class="col-sm-8">Copying files
          <i class="ellipsis"><i>.</i><i>.</i><i>.</i></i>
        </p>
      </div>
      <div ng-if="migrate.copy_files.status == 'finished'">
        <p class="col-sm-4 right"><b>Copy Files:</b></p>
        <p class="col-sm-8">Files copied successfully</p>
      </div>

      <!-- Edit OS Files -->

      <div ng-if="migrate.osedits.status == 'started'">
        <p class="col-sm-4 right"><b>Modify OS:</b></p>
        <p class="col-sm-8">Modifying files
          <i class="ellipsis"><i>.</i><i>.</i><i>.</i></i>
        </p>
      </div>
      <div ng-if="migrate.osedits.status == 'finished'">
        <p class="col-sm-4 right"><b>Modify OS:</b></p>
        <p class="col-sm-8">OS was modified without error
        </p>
      </div>

      <!-- Create Volume -->

      <div ng-if="migrate.detachvolume.status == 'started'">
        <p class="col-sm-4 right"><b>Volume:</b></p>
        <p class="col-sm-8">Detaching volume
          <i class="ellipsis"><i>.</i><i>.</i><i>.</i></i>
        </p>
      </div>
      <div ng-if="migrate.detachvolume.status == 'detaching'">
        <p class="col-sm-4 right"><b>Volume:</b></p>
        <p class="col-sm-8">Waiting for detach to complete
          <i class="ellipsis"><i>.</i><i>.</i><i>.</i></i>
        </p>
      </div>
      <div ng-if="migrate.detachvolume.status == 'finished'">
        <p class="col-sm-4 right"><b>Volume:</b></p>
        <p class="col-sm-8">Detached</p>
      </div>

      <!-- Create Snapshot -->

      <div ng-if="migrate.snapshot.status == 'started'">
        <p class="col-sm-4 right"><b>Snapshot:</b></p>
        <p class="col-sm-8">Creating snapshot
          <i class="ellipsis"><i>.</i><i>.</i><i>.</i></i>
        </p>
      </div>
      <div ng-if="migrate.snapshot.status == 'checking'">
        <p class="col-sm-4 right"><b>Snapshot:</b>
        <p class="col-sm-8">Waiting for snapshot creation to complete
          <i class="ellipsis"><i>.</i><i>.</i><i>.</i></i>
      </div>
      <div ng-if="migrate.snapshot.status == 'finished'">
        <p class="col-sm-4 right"><b>Snapshot:</b>
        <p class="col-sm-8">Created as {{migrate.snapshot.snapshotid}}</p>
      </div>

      <!-- Create AMI -->

      <div ng-if="migrate.ami.status == 'started'">
        <p class="col-sm-4 right"><b>AMI:</b></p>
        <p class="col-sm-8">Creating AMI
          <i class="ellipsis"><i>.</i><i>.</i><i>.</i></i>
        </p>
      </div>
      <div ng-if="migrate.blah.status == 'finished'">
        <p class="col-sm-4 right"><b>AMI:</b></p>
        <p class="col-sm-8">Created as {{migrate.ami.amiid}}</p>
      </div>

      <!-- Create Instance -->

      <div ng-if="migrate.blah.status == 'started'">
        <p class="col-sm-4 right"><b>Modify OS:</b></p>
        <p class="col-sm-8">Modifying files
          <i class="ellipsis"><i>.</i><i>.</i><i>.</i></i>
        </p>
      </div>
      <div ng-if="migrate.blah.status == 'finished'">
        <p class="col-sm-4 right"><b>Modify OS:</b></p>
        <p class="col-sm-8">OS was modified without error</p>
      </div>

      <!-- All Done -->

      <div ng-if="migrate.migration.status == 'alldone'">
        <p class="col-sm-4 right"><b>Migration:</b></p>
        <p class="col-sm-8">COMPLETE!</p>
      </div>
    </div>
  </div>

</div>
